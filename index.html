<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Split-Flap Clock</title>
    <link rel="stylesheet" href="index.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Courier+Prime:wght@700&family=Fira+Code:wght@700&family=Inter:wght@800&family=JetBrains+Mono:wght@800&family=Oswald:wght@700&family=Roboto+Mono:wght@700&family=Space+Mono:wght@700&family=Stardos+Stencil:wght@700&display=swap" rel="stylesheet">
</head>
<body class="bg-enabled">
    <div class="app-container">
        <header>
            <a href="." id="reset-link" class="reset-link"><h1>SPLIT-FLAP</h1></a>
            <div class="controls">
                <div class="control-group">
                    <label class="toggle-container">
                        <input type="radio" name="format" value="24" checked>
                        <span class="label-text">24H</span>
                    </label>
                    <label class="toggle-container">
                        <input type="radio" name="format" value="12">
                        <span class="label-text">12H</span>
                    </label>
                </div>
                <div class="divider"></div>
                <div class="control-group sliders">
                    <div class="slider-item">
                        <label for="width">WIDTH</label>
                        <input type="range" id="width" min="60" max="300" value="100">
                    </div>
                    <div class="slider-item">
                        <label for="height">HEIGHT</label>
                        <input type="range" id="height" min="80" max="400" value="140">
                    </div>
                    <div class="slider-item">
                        <label for="v-offset">V-OFFSET</label>
                        <input type="range" id="v-offset" min="-100" max="100" value="0">
                    </div>
                </div>
                <div class="divider"></div>
                <div class="control-group">
                    <div class="select-item">
                        <label for="font-select">FONT</label>
                        <select id="font-select">
                            <option value="">Default</option>
                            <optgroup label="Modern">
                                <option value="'Inter', sans-serif">Inter</option>
                                <option value="'Oswald', sans-serif">Oswald</option>
                            </optgroup>
                            <optgroup label="Industrial / Retro">
                                <option value="'Bebas Neue', sans-serif">Bebas Neue</option>
                                <option value="'Stardos Stencil', cursive">Stardos Stencil</option>
                                <option value="'Impact', sans-serif">Impact</option>
                                <option value="'Arial Black', sans-serif">Arial Black</option>
                            </optgroup>
                            <optgroup label="Monospaced">
                                <option value="'JetBrains Mono', monospace">JetBrains Mono</option>
                                <option value="'Space Mono', monospace">Space Mono</option>
                                <option value="'Fira Code', monospace">Fira Code</option>
                                <option value="'Roboto Mono', monospace">Roboto Mono</option>
                                <option value="'Courier Prime', monospace">Courier Prime</option>
                            </optgroup>
                        </select>
                    </div>
                <div class="divider"></div>
                <div class="control-group">
                    <label class="toggle-container">
                        <input type="checkbox" id="light-toggle">
                        <span class="label-text">LIGHT</span>
                    </label>
                    <label class="toggle-container">
                        <input type="checkbox" id="fullscreen-toggle">
                        <span class="label-text">FULLSCREEN</span>
                    </label>
                </div>
            </div>
        </header>

        <main>
            <div class="clock">
                <div class="group">
                    <flap-digit id="h1" digit="0"></flap-digit>
                    <flap-digit id="h2" digit="0"></flap-digit>
                </div>
                <div class="separator">:</div>
                <div class="group">
                    <flap-digit id="m1" digit="0"></flap-digit>
                    <flap-digit id="m2" digit="0"></flap-digit>
                </div>
                <div class="separator">:</div>
                <div class="group">
                    <flap-digit id="s1" digit="0"></flap-digit>
                    <flap-digit id="s2" digit="0"></flap-digit>
                </div>
                <div id="ampm" class="ampm-label" style="display: none;">AM</div>
            </div>
        </main>

        <footer>
            <p>AUTHENTIC MECHANICAL MOTION</p>
        </footer>
    </div>

    <script type="module" src="flap-digit.js"></script>
    <script type="module">
        const h1 = document.getElementById('h1');
        const h2 = document.getElementById('h2');
        const m1 = document.getElementById('m1');
        const m2 = document.getElementById('m2');
        const s1 = document.getElementById('s1');
        const s2 = document.getElementById('s2');
        const ampmLabel = document.getElementById('ampm');
        const formatRadios = document.getElementsByName('format');
        const widthSlider = document.getElementById('width');
        const heightSlider = document.getElementById('height');
        const offsetSlider = document.getElementById('v-offset');
        const fontSelect = document.getElementById('font-select');
        const lightToggle = document.getElementById('light-toggle');
        const fullscreenToggle = document.getElementById('fullscreen-toggle');
        const header = document.querySelector('header');
        const clockContainer = document.querySelector('.clock');

        // 1. Collect Defaults
        const DEFAULTS = {
            format: Array.from(formatRadios).find(r => r.checked)?.value || '24',
            width: widthSlider.value,
            height: heightSlider.value,
            'v-offset': offsetSlider.value,
            fontIndex: fontSelect.selectedIndex.toString(),
            light: lightToggle.checked,
            hide: false
        };

        let is24h = DEFAULTS.format === '24';

        function updateClock(force = false) {
            const now = new Date();
            let hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();

            let ampm = '';
            if (!is24h) {
                ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12 || 12;
                ampmLabel.textContent = ampm;
            }

            const hStr = hours.toString().padStart(2, '0');
            const mStr = minutes.toString().padStart(2, '0');
            const sStr = seconds.toString().padStart(2, '0');

            updateDigit(h1, hStr[0], force);
            updateDigit(h2, hStr[1], force);
            updateDigit(m1, mStr[0], force);
            updateDigit(m2, mStr[1], force);
            updateDigit(s1, sStr[0], force);
            updateDigit(s2, sStr[1], force);
        }

        function updateDigit(el, val, force) {
            if (force || el.getAttribute('digit') !== val) {
                el.setAttribute('digit', val);
            }
        }

        setInterval(() => updateClock(), 1000);

        function syncSliderStyles() {
            const w = widthSlider.value + 'px';
            const h = heightSlider.value + 'px';
            const off = offsetSlider.value;
            const f = fontSelect.value;
            const isLight = lightToggle.checked;

            if (isLight) {
                document.body.classList.remove('bg-enabled');
            } else {
                document.body.classList.add('bg-enabled');
            }

            const digits = document.querySelectorAll('flap-digit');
            digits.forEach(d => {
                d.style.width = w;
                d.style.height = h;
                d.setAttribute('hfont', off);
                if (f) {
                    d.setAttribute('font', f);
                } else {
                    d.removeAttribute('font');
                }
            });
            updateUrlFromState();
        }

        // 2. Sync State to URL
        function updateUrlFromState() {
            const params = new URLSearchParams();
            
            const currentFormat = Array.from(formatRadios).find(r => r.checked)?.value;
            if (currentFormat !== DEFAULTS.format) params.set('format', currentFormat);
            
            if (widthSlider.value !== DEFAULTS.width) params.set('width', widthSlider.value);
            if (heightSlider.value !== DEFAULTS.height) params.set('height', heightSlider.value);
            if (offsetSlider.value !== DEFAULTS['v-offset']) params.set('v-offset', offsetSlider.value);
            
            const currentFontIndex = fontSelect.selectedIndex.toString();
            if (currentFontIndex !== DEFAULTS.fontIndex) params.set('fontIndex', currentFontIndex);

            if (lightToggle.checked !== DEFAULTS.light) params.set('light', '1');
            
            const isHidden = header.classList.contains('controls-hidden');
            if (isHidden !== DEFAULTS.hide) params.set('hide', 'true');

            const search = params.toString();
            const newUrl = window.location.pathname + (search ? '?' + search : '');
            if (window.location.search !== (search ? '?' + search : '')) {
                window.history.replaceState({}, '', newUrl);
            }
        }

        // 3. Load from URL (Overlay)
        function loadFromUrl() {
            const params = new URLSearchParams(window.location.search);
            
            if (params.has('format')) {
                const val = params.get('format');
                const radio = Array.from(formatRadios).find(r => r.value === val);
                if (radio) radio.checked = true;
            }
            
            if (params.has('width')) widthSlider.value = params.get('width');
            if (params.has('height')) heightSlider.value = params.get('height');
            if (params.has('v-offset')) offsetSlider.value = params.get('v-offset');
            if (params.has('fontIndex')) {
                const idx = parseInt(params.get('fontIndex'), 10);
                if (!isNaN(idx) && idx >= 0 && idx < fontSelect.options.length) {
                    fontSelect.selectedIndex = idx;
                }
            }
            if (params.has('light')) {
                lightToggle.checked = params.get('light') === '1';
            }
            if (params.has('hide')) {
                if (params.get('hide') === 'true') {
                    header.classList.add('controls-hidden');
                } else {
                    header.classList.remove('controls-hidden');
                }
            }

            // Sync internal state
            is24h = Array.from(formatRadios).find(r => r.checked)?.value === '24';
            ampmLabel.style.display = is24h ? 'none' : 'block';
            syncSliderStyles();
            updateClock(true);
        }

        formatRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                is24h = e.target.value === '24';
                ampmLabel.style.display = is24h ? 'none' : 'block';
                updateClock(true);
                updateUrlFromState();
            });
        });

        widthSlider.addEventListener('input', syncSliderStyles);
        heightSlider.addEventListener('input', syncSliderStyles);
        offsetSlider.addEventListener('input', syncSliderStyles);
        fontSelect.addEventListener('change', syncSliderStyles);
        lightToggle.addEventListener('change', syncSliderStyles);

        function toggleFullscreen() {
            if (document.fullscreenElement) {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            } else {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable full-screen mode: ${err.message}`);
                });
            }
        }

        fullscreenToggle.addEventListener('change', toggleFullscreen);

        // Update toggle state if fullscreen is exited via Esc key
        document.addEventListener('fullscreenchange', () => {
            fullscreenToggle.checked = !!document.fullscreenElement;
        });

        let clickTimer = null;
        clockContainer.addEventListener('click', () => {
            if (clickTimer === null) {
                clickTimer = setTimeout(() => {
                    header.classList.toggle('controls-hidden');
                    updateUrlFromState();
                    clickTimer = null;
                }, 300); // Wait 300ms for a second click
            } else {
                clearTimeout(clickTimer);
                clickTimer = null;
                toggleFullscreen();
            }
        });

        // Initial setup
        window.addEventListener('load', () => {
            document.getElementById('reset-link').href = window.location.origin + window.location.pathname;
            loadFromUrl();
        });
    </script>
</body>
</html>
